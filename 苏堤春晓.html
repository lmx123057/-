<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>苏堤春晓 - 拖拽拼图</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            jiangnan: {
              green: '#82C3EC', // 柳绿
              pink: '#FF9ED2',  // 桃粉
              blue: '#1890FF',  // 湖蓝
              gray: '#E8F4F8',  // 烟雨灰
              dark: '#2A5768'   // 墨色
            }
          },
          fontFamily: {
            kai: ['KaiTi', 'STKaiti', 'serif'], // 楷体适配
            song: ['SimSun', 'STSong', 'serif'] // 宋体适配
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'scale-up': 'scaleUp 0.3s ease-out',
            'success': 'successBounce 1s ease-in-out',
            'shake': 'shake 0.3s ease-in-out',
            'correct': 'correctPulse 0.5s ease-in-out'
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            scaleUp: {
              '0%': { transform: 'scale(0.9)' },
              '100%': { transform: 'scale(1)' }
            },
            successBounce: {
              '0%, 100%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.05)' },
              '75%': { transform: 'scale(0.98)' }
            },
            shake: {
              '0%, 100%': { transform: 'translate(0)' },
              '25%': { transform: 'translate(-5px, 0)' },
              '75%': { transform: 'translate(5px, 0)' }
            },
            correctPulse: {
              '0%': { transform: 'scale(1)' },
              '50%': { transform: 'scale(1.05)', boxShadow: '0 0 15px rgba(130, 195, 236, 0.8)' },
              '100%': { transform: 'scale(1)' }
            }
          }
        }
      }
    }
  </script>
  
  <!-- 自定义样式 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .puzzle-cell {
        @apply relative border-2 border-jiangnan-gray/30 rounded-lg overflow-hidden flex items-center justify-center bg-white/80 transition-all duration-300 hover:border-jiangnan-green/50;
      }
      .puzzle-cell.filled {
        @apply border-jiangnan-green/80 bg-white;
      }
      .puzzle-cell.incorrect {
        @apply border-red-400 animate-shake;
      }
      .puzzle-cell.correct {
        @apply border-jiangnan-green/80 animate-correct;
      }
      .source-img {
        @apply rounded-lg shadow-md cursor-grab transition-all duration-300 hover:shadow-lg hover:scale-[1.02] select-none;
      }
      .source-img.dragging {
        @apply opacity-70 cursor-grabbing scale-[0.98];
      }
      .puzzle-img {
        @apply rounded-lg shadow-md cursor-grab transition-all duration-300 hover:shadow-lg hover:scale-[1.02] select-none w-full h-full;
      }
      .game-container {
        @apply mx-auto rounded-2xl overflow-hidden bg-jiangnan-gray/50 shadow-xl p-4;
      }
      .btn-jiangnan {
        @apply px-6 py-3 rounded-lg font-kai text-lg transition-all hover:shadow-lg active:scale-95;
      }
    }
    
    /* 水墨纹理背景 */
    body {
      background-image: url('https://picsum.photos/id/175/2000/1200');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-blend-mode: overlay;
      background-color: rgba(255, 255, 255, 0.85);
    }
    
    /* 拖拽样式 - 关键修复：确保拖拽元素可被识别 */
    [draggable="true"] {
      user-select: none;
      -webkit-user-drag: element; /* 兼容Safari */
    }
    
    .drop-zone-highlight {
      border-color: #82C3EC !important;
      background-color: rgba(130, 195, 236, 0.1) !important;
    }
    
    /* 确保图片元素层级正确 */
    .puzzle-cell img {
      z-index: 10;
      position: relative;
    }
    
    .placeholder {
      z-index: 1;
      position: absolute;
    }
  </style>
</head>
<body class="min-h-screen font-song text-jiangnan-dark">
  <!-- 页面头部 -->
  <header class="py-6 px-4 bg-white/80 backdrop-blur-sm shadow-md mb-8">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
      <h1 class="text-[clamp(1.8rem,4vw,3rem)] font-kai font-bold text-jiangnan-blue mb-4 md:mb-0">
        <i class="fa fa-pagelines text-jiangnan-pink mr-3"></i>苏堤春晓 · 拖拽拼图
      </h1>
      <div class="flex flex-wrap gap-3 items-center">
        <button id="restart-btn" class="btn-jiangnan bg-jiangnan-blue text-white">
          <i class="fa fa-refresh mr-2"></i>重新开始
        </button>
      </div>
    </div>
  </header>

  <!-- 游戏主区域 -->
  <main class="container mx-auto px-4 pb-16">
    <!-- 游戏信息面板 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 max-w-6xl mx-auto">
      <div class="bg-white/90 rounded-xl p-4 shadow-md animate-fade-in">
        <h3 class="font-kai text-lg mb-1 flex items-center">
          <i class="fa fa-check-circle text-jiangnan-green mr-2"></i>已完成
        </h3>
        <p id="completed-count" class="text-xl font-bold">0/9</p>
      </div>
      <div class="bg-white/90 rounded-xl p-4 shadow-md animate-fade-in">
        <button id="hint-btn" class="w-full btn-jiangnan bg-jiangnan-pink text-white">
          <i class="fa fa-lightbulb-o mr-2"></i>提示 (3次)
        </button>
      </div>
    </div>
    
    <!-- 游戏布局：左侧原图区，右侧拼图区 -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 max-w-7xl mx-auto">
      <!-- 左侧原图区域 -->
      <div class="lg:col-span-1 bg-white/90 rounded-2xl p-4 shadow-xl animate-fade-in">
        <h2 class="font-kai text-xl mb-4 text-center text-jiangnan-dark">
          <i class="fa fa-th-large mr-2 text-jiangnan-pink"></i>素材区
        </h2>
        <div id="source-images" class="grid grid-cols-3 gap-3">
          <!-- 原图会通过JS动态生成 -->
        </div>
        <p class="text-sm text-gray-500 mt-4 text-center">
          点击并拖动图片到右侧拼图区，可自由调整位置
        </p>
      </div>
      
      <!-- 右侧拼图区域 -->
      <div class="lg:col-span-3 animate-fade-in">
        <div class="game-container">
          <h2 class="font-kai text-xl mb-4 text-center text-jiangnan-dark">
            <i class="fa fa-puzzle-piece mr-2 text-jiangnan-green"></i>拼图区 (3×3)
          </h2>
          <!-- 九宫格拼图容器 -->
          <div id="puzzle-grid" class="grid grid-cols-3 gap-2 aspect-square max-w-xl mx-auto">
            <!-- 拼图格子会通过JS动态生成 -->
          </div>
        </div>
        
        <!-- 成功弹窗（初始隐藏） -->
        <div id="success-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 animate-scale-up">
            <div class="text-center">
              <div class="w-20 h-20 rounded-full bg-jiangnan-green/20 flex items-center justify-center mx-auto mb-6">
                <i class="fa fa-trophy text-4xl text-jiangnan-green animate-success"></i>
              </div>
              <h2 class="text-[clamp(1.5rem,3vw,2rem)] font-kai font-bold text-jiangnan-blue mb-2">恭喜完成！</h2>
              <p class="text-jiangnan-dark/80 mb-4">你完美拼好了苏堤春晓九景图</p>
              
              <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <button id="play-again-btn" class="btn-jiangnan bg-jiangnan-blue text-white">
                  <i class="fa fa-play mr-2"></i>再玩一次
                </button>
                <button id="share-btn" class="btn-jiangnan bg-jiangnan-pink text-white">
                  <i class="fa fa-share-alt mr-2"></i>分享成果
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 苏堤小知识（底部） -->
    <div class="mt-8 bg-white/90 rounded-xl p-4 max-w-5xl mx-auto animate-fade-in">
      <h3 class="font-kai text-lg mb-2 flex items-center">
        <i class="fa fa-book text-jiangnan-green mr-2"></i>苏堤小知识
      </h3>
      <p class="text-jiangnan-dark/80">苏堤春晓是西湖十景之首，由北宋苏轼主持修建，全长2.8公里，贯穿西湖南北，六座石拱桥（映波、锁澜、望山、压堤、东浦、跨虹）错落其间，春日桃花柳叶相映，美不胜收。</p>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="bg-jiangnan-dark/90 text-white py-6 px-4">
    <div class="container mx-auto text-center font-kai">
      <p>苏堤春晓 · 拖拽拼图 &copy; 2025</p>
      <p class="text-white/70 text-sm mt-1">春风又绿江南岸，明月何时照我还</p>
    </div>
  </footer>

  <!-- JavaScript核心逻辑 - 完整修复版 -->
  <script>
    // 9张苏堤春晓图片
    const PUZZLE_IMAGES = [
      { id: 0, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/ad6eb2b8173443bab4e4cd002da56af4.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=tV0eXD4toHGpHESLexRDKPFwBJU%3D" },
      { id: 1, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/e908ae0f75c34485ab16074d2ace2187.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=5kJXkIj7%2Bt4NXo8tyfLBjg6BqOA%3D" },
      { id: 2, url: "https://p9-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/2a64fde7337d4e5e89fba4f6a98cd11c.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=oyL91DyC9DGB3YEHaSfSzfXQFEU%3D" },
      { id: 3, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/305fe67a82a34c5cb5b67adaeb38ffba.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=ByyY8BHTboU9Gc%2F%2FdVB4%2BfffTAI%3D" },
      { id: 4, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/cf8c45094c144b89963914591775f6d5.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=xTgfR%2BNaRZ3YgMlSbyf6gQtRS44%3D" },
      { id: 5, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/9560831e52494bcfaa2cc2f29b4e08be.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=n77SFD0yQ5t%2FTWVArcI1GD%2BvxwI%3D" },
      { id: 6, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/58547b87b476431b8b7f20545f1acf9d.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=BEMatbIdqAkdJooC8gidKdbpQKs%3D" },
      { id: 7, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/6cbeafe82cca481fa52a1b23b812b9b5.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=m8nkln1kNznS459Th13oyOQHvbw%3D" },
      { id: 8, url: "https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/3e9e1aa8b27c49b29d64287e7198aade.jpg~tplv-a9rns2rl98-image.png?rcl=202512151626237E15CE151FE38A49E656&rk3s=8e244e95&rrcfp=dafada99&x-expires=2082011183&x-signature=1VjM7%2FZaqEukSTgth5IgWBCtfJk%3D" }
    ];

    // 游戏状态管理
    const gameState = {
      correctPositions: [0, 1, 2, 3, 4, 5, 6, 7, 8], // 正确的位置映射
      puzzleGrid: Array(9).fill(null), // 拼图网格当前状态
      completedCount: 0, // 已完成的拼图块数
      hintCount: 3, // 剩余提示次数
      isCompleted: false, // 是否完成
      shuffledImages: [], // 打乱后的图片数组
      draggedItem: null, // 当前拖拽的元素
      draggedFrom: null, // 拖拽来源：'source' 或 'puzzle'
    };

    // DOM元素缓存
    const elements = {
      sourceImagesContainer: document.getElementById('source-images'),
      puzzleGridContainer: document.getElementById('puzzle-grid'),
      completedCountEl: document.getElementById('completed-count'),
      hintBtn: document.getElementById('hint-btn'),
      restartBtn: document.getElementById('restart-btn'),
      successModal: document.getElementById('success-modal'),
      playAgainBtn: document.getElementById('play-again-btn'),
      shareBtn: document.getElementById('share-btn'),
    };

    // 初始化游戏
    function initGame() {
      // 重置游戏状态
      gameState.puzzleGrid = Array(9).fill(null);
      gameState.completedCount = 0;
      gameState.hintCount = 3;
      gameState.isCompleted = false;
      gameState.draggedItem = null;
      gameState.draggedFrom = null;
      
      // 打乱图片顺序（用于素材区展示）
      gameState.shuffledImages = [...PUZZLE_IMAGES].sort(() => Math.random() - 0.5);
      
      // 清空容器
      elements.sourceImagesContainer.innerHTML = '';
      elements.puzzleGridContainer.innerHTML = '';
      
      // 隐藏成功弹窗
      elements.successModal.classList.add('hidden');
      
      // 生成素材区图片
      generateSourceImages();
      
      // 生成拼图网格
      generatePuzzleGrid();
      
      // 更新UI
      updateCompletedCount();
      updateHintButton();
    }

    // 生成素材区图片（可拖拽）
    function generateSourceImages() {
      gameState.shuffledImages.forEach(img => {
        const imgElement = createDraggableImageElement(img, 'source');
        elements.sourceImagesContainer.appendChild(imgElement);
      });
    }

    // 创建可拖拽的图片元素 - 关键修复：确保元素结构简单
    function createDraggableImageElement(imgInfo, type) {
      // 1. 创建外层容器
      const container = document.createElement('div');
      container.className = type === 'source' ? 'source-img' : 'puzzle-img';
      container.dataset.imgId = imgInfo.id;
      container.dataset.type = type;
      container.draggable = true;
      container.style.width = '100%';
      container.style.height = '100%';
      
      // 2. 创建图片元素（单独创建，避免嵌套问题）
      const img = document.createElement('img');
      img.src = imgInfo.url;
      img.alt = `苏堤春晓${imgInfo.id+1}`;
      img.className = 'w-full h-full object-cover rounded-lg aspect-square';
      img.draggable = false; // 禁止图片本身拖拽，只允许外层容器拖拽
      
      // 3. 组装元素
      container.innerHTML = '';
      container.appendChild(img);
      
      // 4. 绑定拖拽事件
      container.addEventListener('dragstart', handleDragStart);
      container.addEventListener('dragend', handleDragEnd);
      
      return container;
    }

    // 生成拼图网格（9个格子）
    function generatePuzzleGrid() {
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement('div');
        cell.className = 'puzzle-cell';
        cell.dataset.gridIndex = i;
        cell.style.minHeight = '100px'; // 关键修复：确保单元格有最小高度
        
        // 放置区提示
        cell.innerHTML = `
          <div class="placeholder text-gray-400 text-sm">
            <i class="fa fa-image block mb-1"></i>
            拖拽图片到这里
          </div>
        `;
        
        // 拖放事件监听 - 关键修复：绑定到单元格本身
        cell.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        });
        cell.addEventListener('dragenter', (e) => {
          e.preventDefault();
          cell.classList.add('drop-zone-highlight');
        });
        cell.addEventListener('dragleave', () => {
          cell.classList.remove('drop-zone-highlight');
        });
        cell.addEventListener('drop', handleDrop);
        
        elements.puzzleGridContainer.appendChild(cell);
      }
    }

    // 拖拽开始 - 关键修复：稳定获取拖拽元素和数据
    function handleDragStart(e) {
      // 1. 阻止冒泡，确保获取正确的拖拽元素
      e.stopPropagation();
      
      // 2. 获取最外层的拖拽容器（避免点击图片内部导致的问题）
      const dragContainer = e.target.closest('[draggable="true"]');
      if (!dragContainer) return;
      
      // 3. 记录拖拽状态
      gameState.draggedItem = dragContainer;
      gameState.draggedFrom = dragContainer.dataset.type;
      
      // 4. 添加拖拽样式
      dragContainer.classList.add('dragging');
      dragContainer.style.opacity = '0.5';
      
      // 5. 强制设置拖拽数据（兼容所有浏览器）
      const imgId = dragContainer.dataset.imgId;
      e.dataTransfer.setData('text', imgId); // 使用text格式，兼容更多浏览器
      e.dataTransfer.effectAllowed = 'move';
      
      // 6. 修复Firefox拖拽预览
      e.dataTransfer.setDragImage(dragContainer, 20, 20);
    }

    // 拖拽结束 - 关键修复：恢复样式
    function handleDragEnd(e) {
      e.stopPropagation();
      
      const dragContainer = e.target.closest('[draggable="true"]');
      if (dragContainer) {
        dragContainer.classList.remove('dragging');
        dragContainer.style.opacity = '1';
      }
      
      // 移除所有单元格的高亮
      document.querySelectorAll('.puzzle-cell').forEach(cell => {
        cell.classList.remove('drop-zone-highlight');
      });
      
      // 重置拖拽状态
      gameState.draggedItem = null;
      gameState.draggedFrom = null;
    }

    // 放置图片 - 核心修复：确保DOM操作顺序正确
    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // 1. 获取目标单元格
      const cell = e.target.closest('.puzzle-cell');
      if (!cell) return;
      const gridIndex = parseInt(cell.dataset.gridIndex);
      
      // 2. 获取拖拽的图片ID（兼容不同数据格式）
      const imgIdStr = e.dataTransfer.getData('text') || e.dataTransfer.getData('text/plain');
      const imgId = parseInt(imgIdStr);
      if (isNaN(imgId)) return; // 无效ID直接返回
      
      // 3. 移除高亮
      cell.classList.remove('drop-zone-highlight');
      
      // 4. 获取图片信息
      const imgInfo = PUZZLE_IMAGES.find(img => img.id === imgId);
      if (!imgInfo) return; // 图片信息不存在直接返回
      
      // 5. 根据拖拽来源处理
      if (gameState.draggedFrom === 'source') {
        // 从素材区拖到拼图区
        placeImageInPuzzleCell(cell, gridIndex, imgInfo);
      } else if (gameState.draggedFrom === 'puzzle') {
        // 从拼图区拖到另一个拼图单元格
        moveImageBetweenPuzzleCells(cell, gridIndex, imgInfo);
      }
      
      // 6. 检查游戏完成状态
      checkGameCompletion();
    }

    // 将图片放置到拼图单元格 - 关键修复：DOM操作顺序
    function placeImageInPuzzleCell(cell, gridIndex, imgInfo) {
      try {
        // 1. 如果目标单元格已有图片，先放回素材区
        if (gameState.puzzleGrid[gridIndex] !== null) {
          const existingImgId = gameState.puzzleGrid[gridIndex];
          returnImageToSource(existingImgId);
        }
        
        // 2. 清空目标单元格（关键：先清空再添加）
        cell.innerHTML = '';
        
        // 3. 移除素材区的原图片
        removeSourceImage(imgInfo.id);
        
        // 4. 创建拼图区图片元素并添加
        const puzzleImg = createDraggableImageElement(imgInfo, 'puzzle');
        cell.appendChild(puzzleImg);
        
        // 5. 更新单元格样式和游戏状态
        cell.classList.add('filled');
        gameState.puzzleGrid[gridIndex] = imgInfo.id;
        
        // 6. 检查是否放置正确
        checkPuzzleCellAccuracy(cell, gridIndex, imgInfo.id);
        
        // 7. 强制DOM重绘（解决渲染延迟）
        cell.offsetHeight;
        
        // 8. 更新完成数量
        updateCompletedCount();
        
      } catch (error) {
        console.error('放置图片失败:', error);
      }
    }

    // 在拼图单元格之间移动图片 - 关键修复：确保状态同步
    function moveImageBetweenPuzzleCells(targetCell, targetIndex, imgInfo) {
      try {
        // 1. 找到源单元格索引
        const sourceIndex = gameState.puzzleGrid.findIndex(id => id === imgInfo.id);
        if (sourceIndex === -1 || sourceIndex === targetIndex) return;
        
        // 2. 获取源单元格
        const sourceCell = document.querySelectorAll('.puzzle-cell')[sourceIndex];
        if (!sourceCell) return;
        
        // 3. 保存目标单元格原有图片ID
        const targetImgId = gameState.puzzleGrid[targetIndex];
        
        // 4. 清空源单元格
        sourceCell.innerHTML = `
          <div class="placeholder text-gray-400 text-sm">
            <i class="fa fa-image block mb-1"></i>
            拖拽图片到这里
          </div>
        `;
        sourceCell.classList.remove('filled', 'correct', 'incorrect');
        gameState.puzzleGrid[sourceIndex] = null;
        
        // 5. 如果目标单元格有图片，移动到源单元格
        if (targetImgId !== null) {
          const targetImgInfo = PUZZLE_IMAGES.find(img => img.id === targetImgId);
          if (targetImgInfo) {
            sourceCell.innerHTML = '';
            const sourceImg = createDraggableImageElement(targetImgInfo, 'puzzle');
            sourceCell.appendChild(sourceImg);
            sourceCell.classList.add('filled');
            gameState.puzzleGrid[sourceIndex] = targetImgId;
            checkPuzzleCellAccuracy(sourceCell, sourceIndex, targetImgId);
          }
        }
        
        // 6. 清空目标单元格并添加新图片
        targetCell.innerHTML = '';
        const targetImg = createDraggableImageElement(imgInfo, 'puzzle');
        targetCell.appendChild(targetImg);
        targetCell.classList.add('filled');
        gameState.puzzleGrid[targetIndex] = imgInfo.id;
        checkPuzzleCellAccuracy(targetCell, targetIndex, imgInfo.id);
        
        // 7. 强制DOM重绘
        sourceCell.offsetHeight;
        targetCell.offsetHeight;
        
        // 8. 更新完成数量
        updateCompletedCount();
        
      } catch (error) {
        console.error('移动图片失败:', error);
      }
    }

    // 检查拼图单元格放置是否正确
    function checkPuzzleCellAccuracy(cell, gridIndex, imgId) {
      cell.classList.remove('correct', 'incorrect');
      
      if (imgId === gameState.correctPositions[gridIndex]) {
        cell.classList.add('correct');
      } else {
        cell.classList.add('incorrect');
        setTimeout(() => {
          cell.classList.remove('incorrect');
        }, 500);
      }
    }

    // 移除素材区的图片
    function removeSourceImage(imgId) {
      const sourceImages = document.querySelectorAll('.source-img');
      sourceImages.forEach(img => {
        if (parseInt(img.dataset.imgId) === imgId) {
          img.remove();
        }
      });
    }

    // 将图片放回素材区
    function returnImageToSource(imgId) {
      const imgInfo = PUZZLE_IMAGES.find(img => img.id === imgId);
      if (!imgInfo) return;
      
      // 先检查素材区是否已有该图片
      const existing = Array.from(document.querySelectorAll('.source-img')).find(
        el => parseInt(el.dataset.imgId) === imgId
      );
      if (existing) return;
      
      const imgElement = createDraggableImageElement(imgInfo, 'source');
      elements.sourceImagesContainer.appendChild(imgElement);
    }

    // 更新完成数量显示
    function updateCompletedCount() {
      // 计算正确放置的拼图数量
      gameState.completedCount = gameState.puzzleGrid.reduce((count, imgId, index) => {
        return imgId === gameState.correctPositions[index] ? count + 1 : count;
      }, 0);
      
      elements.completedCountEl.textContent = `${gameState.completedCount}/9`;
    }

    // 更新提示按钮状态
    function updateHintButton() {
      elements.hintBtn.innerHTML = `
        <i class="fa fa-lightbulb-o mr-2"></i>提示 (${gameState.hintCount}次)
      `;
      
      if (gameState.hintCount <= 0 || gameState.isCompleted) {
        elements.hintBtn.disabled = true;
        elements.hintBtn.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        elements.hintBtn.disabled = false;
        elements.hintBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    // 检查游戏是否完成
    function checkGameCompletion() {
      if (gameState.completedCount === 9 && !gameState.isCompleted) {
        gameState.isCompleted = true;
        setTimeout(() => {
          elements.successModal.classList.remove('hidden');
        }, 500);
      }
    }

    // 提示功能
    function showHint() {
      if (gameState.hintCount <= 0 || gameState.isCompleted) return;
      
      // 找到第一个未完成的位置
      const emptyIndex = gameState.puzzleGrid.findIndex((val, index) => {
        return val !== gameState.correctPositions[index];
      });
      
      if (emptyIndex !== -1) {
        // 获取正确的图片ID
        const correctImgId = gameState.correctPositions[emptyIndex];
        
        // 高亮拼图位置
        const puzzleCells = document.querySelectorAll('.puzzle-cell');
        const targetCell = puzzleCells[emptyIndex];
        targetCell.classList.add('ring-4', 'ring-jiangnan-pink', 'animate-scale-up');
        
        // 查找对应的图片
        let targetImg = null;
        const sourceImages = document.querySelectorAll('.source-img');
        sourceImages.forEach(img => {
          if (parseInt(img.dataset.imgId) === correctImgId) {
            targetImg = img;
          }
        });
        
        if (!targetImg) {
          const puzzleImages = document.querySelectorAll('.puzzle-img');
          puzzleImages.forEach(img => {
            if (parseInt(img.dataset.imgId) === correctImgId) {
              targetImg = img;
            }
          });
        }
        
        // 高亮图片
        if (targetImg) {
          targetImg.classList.add('ring-4', 'ring-jiangnan-green', 'animate-scale-up');
          setTimeout(() => {
            targetImg.classList.remove('ring-4', 'ring-jiangnan-green', 'animate-scale-up');
          }, 3000);
        }
        
        // 3秒后移除拼图位置高亮
        setTimeout(() => {
          targetCell.classList.remove('ring-4', 'ring-jiangnan-pink', 'animate-scale-up');
        }, 3000);
        
        // 减少提示次数
        gameState.hintCount--;
        updateHintButton();
      }
    }

    // 绑定事件监听
    function bindEvents() {
      // 重新开始
      elements.restartBtn.addEventListener('click', initGame);
      
      // 提示按钮
      elements.hintBtn.addEventListener('click', showHint);
      
      // 再玩一次
      elements.playAgainBtn.addEventListener('click', initGame);
      
      // 分享按钮（模拟）
      elements.shareBtn.addEventListener('click', () => {
        alert('恭喜！你已成功拼出苏堤春晓九宫格，快来分享给好友吧～');
      });
      
      // 关键修复：允许将拼图拖回素材区
      elements.sourceImagesContainer.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      });
      
      elements.sourceImagesContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        const imgIdStr = e.dataTransfer.getData('text') || e.dataTransfer.getData('text/plain');
        const imgId = parseInt(imgIdStr);
        if (!isNaN(imgId) && gameState.draggedFrom === 'puzzle') {
          // 从拼图区拖回素材区
          const sourceIndex = gameState.puzzleGrid.findIndex(id => id === imgId);
          if (sourceIndex !== -1) {
            const sourceCell = document.querySelectorAll('.puzzle-cell')[sourceIndex];
            sourceCell.innerHTML = `
              <div class="placeholder text-gray-400 text-sm">
                <i class="fa fa-image block mb-1"></i>
                拖拽图片到这里
              </div>
            `;
            sourceCell.classList.remove('filled', 'correct', 'incorrect');
            gameState.puzzleGrid[sourceIndex] = null;
            returnImageToSource(imgId);
            updateCompletedCount();
          }
        }
      });
    }

    // 页面加载完成初始化
    document.addEventListener('DOMContentLoaded', () => {
      bindEvents();
      initGame();
    });
  </script>
</body>
</html>